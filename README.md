# tbone-ssm

This repository was adapted from Runze Han's SSM code (Siewerdsen Lab) and repurposed for temporal bone SSM generation. The file structure is shown below:
```
> base_dir/
  > segmentations/
    (ground truth segmentations)
    > Segmentation <SIDE> <ID>.nrrd
      (example: Segmentation RT 138.nrrd)
  > predictions/
    (predicted segmentations from label propagation)
    > Segmentation <SIDE> <TEMPLATE_ID> <TARGET_ID>-<ANTs registration protocol>[-flipped].nrrd
      (example: Segmentation RT 153 138-syn80-demons-downsample300.nrrd)
  > ssm_surfaces[_groundtruth]/
    (meshes that will be used for SSM generation)
    > <PART>_<SIDE>_<TEMPLATE_ID>[_TARGET_ID][_flipped][_zero_origin].vtk
      (example: Malleus_RT_153_138.vtk)
  > ssm_H5[_groundtruth]/
    (H5 files that contain SSM mode weights)
    > pca_surfaces/
      (meshes generated from explore_ssm.m)
      > SSM_<PART>_<SIDE>_<TEMPLATE_ID>[_zero_origin]_pca_<MODE_ID>_<SD>.vtk
        (mesh generated by adjusting one mode weight)
      > SSM_<PART>_<SIDE>_<TEMPLATE_ID>[_zero_origin]_pca_ensemble_<SD_1>_<SD_2>.vtk
        (mesh generated by concurrently adjusting weights of the first two modes)
    > SSM_<PART>_<SIDE>_<TEMPLATE_ID>[_zero_origin].h5
      (example: SSM_Malleus_RT_153.h5)
      
KEY: (comments), <naming convention variable>, [optional]
<SIDE>: Side of the seed segment used for SSM generation (RT or LT)
<ID>: Dataset ID
<TEMPLATE_ID>: Dataset ID that the seed segment is from
<TARGET_ID>: Dataset ID from which a predicted segment is from
<PART>: Segment name
<MODE_ID>: PCA mode (1, 2, 3)
<SD>: Number of standard deviations away from the mean for a given mode
<SD_1>: Number of standard deviations away from the mean for a the 1st PCA mode
<SD_2>: Number of standard deviations away from the mean for a the 2nd PCA mode
```

Currently, `buildtboneSSM_groundtruth.m` and `buildtboneSSM_propagated.m` are used to generate SSMs from ground truth and label-propagated segmentations, respectively. Several variables (including but not limited to side, template ID, target IDs to exclude, and segment IDs) are currently hand-coded. In the future, `SSM_tbone.m` will be used as a wrapper for the aforementioned scripts.

We have extended the Siewerdsen Lab's SSM generation code in the following ways:
  - Compatibility with segments contralateral to the template's side
  - Compatibility with multiple segment IDs for multi-structure SSM generation
  - Optimized non-rigid CPD step with `beta=4` and `lambda=3`
  - Improved SSM visualization in `explore_ssm.m` with capability of writing SSM-generated meshes
